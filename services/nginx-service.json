{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "ECS Service for Nginx with ALB integration",
  "Parameters": {
    "ClusterStackName": {
      "Type": "String",
      "Description": "Name of the CloudFormation stack containing the ECS cluster"
    },
    "ALBStackName": {
      "Type": "String",
      "Description": "Name of the CloudFormation stack containing the ALB"
    },
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC ID for the service"
    },
    "PrivateSubnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "List of private subnet IDs for the ECS service"
    },
    "TaskDefinitionArn": {
      "Type": "String",
      "Description": "ARN of the Task Definition to use"
    },
    "DesiredCount": {
      "Type": "Number",
      "Default": 2,
      "MinValue": 1,
      "MaxValue": 10,
      "Description": "Number of desired tasks"
    },
    "MaxCapacity": {
      "Type": "Number",
      "Default": 4,
      "MinValue": 1,
      "MaxValue": 20,
      "Description": "Maximum number of tasks for auto-scaling"
    },
    "MinCapacity": {
      "Type": "Number",
      "Default": 1,
      "MinValue": 1,
      "MaxValue": 10,
      "Description": "Minimum number of tasks for auto-scaling"
    }
  },
  "Resources": {
    "ECSServiceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": "nginx-ecs-service-sg",
        "GroupDescription": "Security Group for ECS Service",
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "SourceSecurityGroupId": {
              "Fn::ImportValue": {
                "Fn::Sub": "${ALBStackName}-ALB-SG"
              }
            },
            "Description": "Allow traffic from ALB on port 80"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 8080,
            "ToPort": 8080,
            "SourceSecurityGroupId": {
              "Fn::ImportValue": {
                "Fn::Sub": "${ALBStackName}-ALB-SG"
              }
            },
            "Description": "Allow traffic from ALB on port 8080"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "SourceSecurityGroupId": {
              "Fn::ImportValue": {
                "Fn::Sub": "${ALBStackName}-ALB-SG"
              }
            },
            "Description": "Allow traffic from ALB on port 443"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "nginx-ecs-service-sg"
          }
        ]
      }
    },
    "ECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "ServiceName": "nginx-service",
        "Cluster": {
          "Fn::ImportValue": {
            "Fn::Sub": "${ClusterStackName}-ClusterName"
          }
        },
        "TaskDefinition": {
          "Ref": "TaskDefinitionArn"
        },
        "DesiredCount": {
          "Ref": "DesiredCount"
        },
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "SecurityGroups": [
              {
                "Ref": "ECSServiceSecurityGroup"
              }
            ],
            "Subnets": {
              "Ref": "PrivateSubnets"
            }
          }
        },
        "LoadBalancers": [
          {
            "ContainerName": "nginx",
            "ContainerPort": 80,
            "TargetGroupArn": {
              "Fn::ImportValue": {
                "Fn::Sub": "${ALBStackName}-TG-80-ARN"
              }
            }
          },
          {
            "ContainerName": "nginx",
            "ContainerPort": 8080,
            "TargetGroupArn": {
              "Fn::ImportValue": {
                "Fn::Sub": "${ALBStackName}-TG-8080-ARN"
              }
            }
          }
        ],
        "HealthCheckGracePeriodSeconds": 60,
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 50,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "EnableECSManagedTags": true,
        "PropagateTags": "TASK_DEFINITION",
        "Tags": [
          {
            "Key": "Name",
            "Value": "nginx-service"
          },
          {
            "Key": "Environment",
            "Value": "Production"
          }
        ]
      }
    },
    "ServiceScalableTarget": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": {
          "Ref": "MaxCapacity"
        },
        "MinCapacity": {
          "Ref": "MinCapacity"
        },
        "ResourceId": {
          "Fn::Sub": "service/${ClusterStackName}-ClusterName/nginx-service"
        },
        "RoleARN": {
          "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    "ServiceScalingPolicy": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": "nginx-cpu-scaling-policy",
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "ServiceScalableTarget"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": 70.0,
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60
        }
      }
    }
  },
  "Outputs": {
    "ServiceName": {
      "Description": "Name of the ECS Service",
      "Value": {
        "Fn::GetAtt": ["ECSService", "Name"]
      }
    },
    "ServiceArn": {
      "Description": "ARN of the ECS Service",
      "Value": {
        "Ref": "ECSService"
      }
    },
    "SecurityGroupId": {
      "Description": "Security Group ID of the ECS Service",
      "Value": {
        "Ref": "ECSServiceSecurityGroup"
      }
    }
  }
}