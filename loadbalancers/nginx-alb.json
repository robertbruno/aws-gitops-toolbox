{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Application Load Balancer with listeners for ports 80, 443, and 8080",
  "Parameters": {
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC ID where the ALB will be deployed"
    },
    "PublicSubnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "List of public subnet IDs for the ALB (minimum 2)"
    },
    "CertificateArn": {
      "Type": "String",
      "Default": "",
      "Description": "ACM Certificate ARN for HTTPS listener (optional)"
    }
  },
  "Conditions": {
    "HasCertificate": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            { "Ref": "CertificateArn" },
            ""
          ]
        }
      ]
    }
  },
  "Resources": {
    "ALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": "nginx-alb-sg",
        "GroupDescription": "Security Group for Application Load Balancer",
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTP traffic"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTPS traffic"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 8080,
            "ToPort": 8080,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow traffic on port 8080"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "nginx-alb-sg"
          }
        ]
      }
    },
    "ApplicationLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Name": "nginx-alb",
        "Type": "application",
        "Scheme": "internet-facing",
        "IpAddressType": "ipv4",
        "SecurityGroups": [
          {
            "Ref": "ALBSecurityGroup"
          }
        ],
        "Subnets": {
          "Ref": "PublicSubnets"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "nginx-alb"
          },
          {
            "Key": "Environment",
            "Value": "Production"
          }
        ]
      }
    },
    "TargetGroup80": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": "nginx-tg-80",
        "Port": 80,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "TargetType": "ip",
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/health",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckPort": "80",
        "HealthCheckIntervalSeconds": 30,
        "HealthCheckTimeoutSeconds": 5,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "Matcher": {
          "HttpCode": "200,404"
        },
        "TargetGroupAttributes": [
          {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "30"
          },
          {
            "Key": "stickiness.enabled",
            "Value": "true"
          },
          {
            "Key": "stickiness.type",
            "Value": "lb_cookie"
          },
          {
            "Key": "stickiness.lb_cookie.duration_seconds",
            "Value": "86400"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "nginx-tg-80"
          }
        ]
      }
    },
    "TargetGroup8080": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": "nginx-tg-8080",
        "Port": 8080,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "TargetType": "ip",
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/api/health",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckPort": "8080",
        "HealthCheckIntervalSeconds": 30,
        "HealthCheckTimeoutSeconds": 5,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "Matcher": {
          "HttpCode": "200"
        },
        "TargetGroupAttributes": [
          {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "30"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "nginx-tg-8080"
          }
        ]
      }
    },
    "HTTPListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroup80"
            }
          }
        ],
        "LoadBalancerArn": {
          "Ref": "ApplicationLoadBalancer"
        },
        "Port": 80,
        "Protocol": "HTTP"
      }
    },
    "HTTPSListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Condition": "HasCertificate",
      "Properties": {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroup80"
            }
          }
        ],
        "LoadBalancerArn": {
          "Ref": "ApplicationLoadBalancer"
        },
        "Port": 443,
        "Protocol": "HTTPS",
        "Certificates": [
          {
            "CertificateArn": {
              "Ref": "CertificateArn"
            }
          }
        ],
        "SslPolicy": "ELBSecurityPolicy-TLS-1-2-2017-01"
      }
    },
    "Listener8080": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroup8080"
            }
          }
        ],
        "LoadBalancerArn": {
          "Ref": "ApplicationLoadBalancer"
        },
        "Port": 8080,
        "Protocol": "HTTP"
      }
    }
  },
  "Outputs": {
    "LoadBalancerDNS": {
      "Description": "DNS name of the load balancer",
      "Value": {
        "Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ALB-DNS"
        }
      }
    },
    "LoadBalancerArn": {
      "Description": "ARN of the load balancer",
      "Value": {
        "Ref": "ApplicationLoadBalancer"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ALB-ARN"
        }
      }
    },
    "TargetGroup80Arn": {
      "Description": "ARN of Target Group for port 80",
      "Value": {
        "Ref": "TargetGroup80"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TG-80-ARN"
        }
      }
    },
    "TargetGroup8080Arn": {
      "Description": "ARN of Target Group for port 8080",
      "Value": {
        "Ref": "TargetGroup8080"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TG-8080-ARN"
        }
      }
    },
    "SecurityGroupId": {
      "Description": "Security Group ID of the ALB",
      "Value": {
        "Ref": "ALBSecurityGroup"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ALB-SG"
        }
      }
    }
  }
}